<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <title>TontonKAD - Organisateur de Fourreaux & Câbles</title>
    <meta name="description" content="Application web pour organiser fourreaux et câbles électriques - Calcul d'occupation et visualisation 2D"/>
    <meta name="keywords" content="fourreaux, câbles, électricité, organisation, calcul, visualisation"/>
    <meta name="author" content="TontonKAD"/>
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website"/>
    <meta property="og:title" content="TontonKAD - Organisateur de Fourreaux & Câbles"/>
    <meta property="og:description" content="Application web pour organiser fourreaux et câbles électriques"/>
    <meta property="og:image" content="TONTONKAD.svg"/>
    
    <!-- Security -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'"/>
    
    <link rel="icon" type="image/svg+xml" href="TONTONKAD.svg"/>
    <link rel="stylesheet" href="style.css"/>
    
    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#475569">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TontonKAD">
    <link rel="apple-touch-icon" href="TONTONKAD.svg">
    
    <!-- Préchargement des ressources critiques -->
    <link rel="preload" href="script.js" as="script">
    <link rel="preload" href="data/cables.csv" as="fetch" crossorigin>
    <link rel="preload" href="data/fourreaux.csv" as="fetch" crossorigin>
    <link rel="preload" href="data/chemins_de_cable.csv" as="fetch" crossorigin>
</head>
<body>
  <div class="wrap">
    <aside class="panel">
      <div class="panel-resize-handle"></div>
      <div class="brand">
        <img src="TONTONKAD.svg" class="logo" alt="Logo" />
        <h1>Organisateur de Fourreaux & Câbles</h1>
      </div>
      <div class="panel-controls">
        <div class="row">
          <label for="shape">Forme de la boîte</label>
          <select id="shape">
            <option value="rect">Boîte rectangulaire</option>
            <option value="circ">Conduit circulaire</option>
            <option value="chemin_de_cable">Chemin de câble</option>
          </select>
        </div>
        <div id="rectInputs">
          <div class="row">
            <label for="boxW">Largeur (mm)</label>
            <input id="boxW" type="number" step="0.1" value="1000" />
          </div>
          <div class="row">
            <label for="boxH">Hauteur (mm)</label>
            <input id="boxH" type="number" step="0.1" value="1000" />
          </div>
          <div class="apply-dimensions-container">
            <button id="apply" class="btn apply-btn hidden" aria-label="Appliquer les nouvelles dimensions - Raccourci: Entrée">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Appliquer les dimensions</title>
                <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span class="apply-text">Appliquer dimensions</span>
            </button>
          </div>
        </div>
        <div id="circInputs" class="hidden">
          <div class="row">
            <label for="boxD">Diamètre (mm)</label>
            <input id="boxD" type="number" step="0.1" value="1000" />
          </div>
          <div class="apply-dimensions-container">
            <button id="applyCirc" class="btn apply-btn hidden" aria-label="Appliquer les nouvelles dimensions - Raccourci: Entrée">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Appliquer les dimensions</title>
                <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span class="apply-text">Appliquer dimensions</span>
            </button>
          </div>
        </div>
        <div class="card hidden">
          <div class="row">
            <label for="targetPxPerMm">Échelle cible (px/mm)</label>
            <input id="targetPxPerMm" type="number" step="0.01" value="1.00" />
          </div>
        </div>
        <div class="card">
          <div class="tabs">
            <div id="tabFOURREAU" class="tab active">FOURREAU</div>
            <div id="tabCABLE" class="tab">CÂBLE</div>
          </div>
          <div id="paneFOURREAU">
            <div class="row">
              <label for="fourreauSelect">Type de Fourreau</label>
              <select id="fourreauSelect"></select>
            </div>
            <div class="small">
              Le Fourreau est un <b>anneau</b> :
              <span class="pill">Ø ext = code</span>,
              <span class="pill">Ø int ≥ liste</span>.
            </div>
          </div>
          <div id="paneCABLE" class="hidden">
            <div class="row">
              <label for="cableSelect">Type de Câble</label>
              <select id="cableSelect"></select>
            </div>
            <div class="small">
              Un Câble est <b>plein</b>, contrôle Ø si dans un Fourreau.
            </div>
          </div>
        </div>
        <div class="two-cols">
          <div class="card listwrap">
            <div class="headerline">
              <b>Inventaire Fourreaux</b>
              <span class="muted">
                Objets: <span id="countInvF">0</span> • Types:
                <span id="typesInvF">0</span>
              </span>
            </div>
            <input
              id="searchFourreau"
              class="search"
              placeholder="Rechercher Fourreau (type, code)…"
            />
            <div
              id="listFourreau"
              class="list"
              role="listbox"
              aria-label="Inventaire Fourreaux"
            ></div>
            <div class="small">
              1 ligne par type (× quantité). Clique pour sélectionner un
              exemplaire, double‑clic pour passer au suivant.
            </div>
          </div>
          <div class="card listwrap">
            <div class="headerline">
              <b>Inventaire Câbles</b>
              <span class="muted">
                Objets: <span id="countInvC">0</span> • Types:
                <span id="typesInvC">0</span>
              </span>
            </div>
            <input
              id="searchCable"
              class="search"
              placeholder="Rechercher CÂBLE (famille, code)…"
            />
            <div
              id="listCable"
              class="list"
              role="listbox"
              aria-label="Inventaire CÂBLES"
            ></div>
            <div class="small">
              1 ligne par type (× quantité). Clique pour sélectionner un
              exemplaire, double‑clic pour passer au suivant.
            </div>
          </div>
        </div>
        <div class="card">
          <b>Détails sélection</b>
          <div id="selInfo" class="info-list muted">
            Aucun objet sélectionné.
          </div>
        </div>
      </div>
      
      <div class="panel-stats">
        <div class="card">
          <div class="row">
            <div>Total Fourreaux</div>
            <div class="kpi">
              <span id="statFourreau">0</span>
            </div>
          </div>
          <div class="row">
            <div>Total Câbles</div>
            <div class="kpi">
              <span id="statCable">0</span>
            </div>
          </div>
          <div class="row">
            <div>Taux d'occupation</div>
            <div class="kpi">
              <span id="statOccupation">0.0 %</span>
            </div>
          </div>
          <div class="row">
            <div>Échelle d'affichage</div>
            <div>
              <span id="scaleInfo">—</span>
            </div>
          </div>
        </div>
      </div>
    </aside>
    <div class="canvas-section">
      <div class="main-view">
        <main class="canvas-wrap">
          <canvas id="world"></canvas>
          <!-- Cotes pour la largeur -->
          <div id="dimensionWidth" class="dimension-line horizontal" style="display: none;">
            <span class="dimension-text"></span>
          </div>
          <!-- Cotes pour la hauteur -->
          <div id="dimensionHeight" class="dimension-line vertical" style="display: none;">
            <span class="dimension-text"></span>
          </div>
        </main>
        <div class="zoom-control-vertical">
          <label for="zoomSlider">Zoom</label>
          <input
            id="zoomSlider"
            class="range"
            type="range"
            min="25"
            max="300"
            step="5"
            value="100"
          />
          <div class="zoom-value"><span id="zoomLabel">100</span>%</div>
        </div>
      </div>
      <div class="canvas-controls">
        <div class="canvas-controls-row">
          <div class="canvas-controls-left">
            <button id="toolEdit" class="btn" aria-label="Outil d'édition - Raccourci: E">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Icône d'édition</title>
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="#e5f0ff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4z" stroke="#e5f0ff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Éditer (E)
            </button>
            <button id="toolInfo" class="btn" aria-label="Outil d'information - Raccourci: I">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Icône d'information</title>
                <circle cx="12" cy="12" r="10" stroke="#e5f0ff" stroke-width="2" fill="none"/>
                <path d="M9,9 h6 a3,3 0 0,1 0,6 h-6" stroke="#e5f0ff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="12" y1="17" x2="12.01" y2="17" stroke="#e5f0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Infos (I)
            </button>
            <button id="freezeBtn" class="btn" disabled aria-label="Figer l'objet sélectionné - Raccourci: G">Figer (G)</button>
            <button id="toolDelete" class="btn" aria-label="Supprimer l'objet sélectionné - Raccourci: Suppr">Supprimer (Suppr)</button>
          </div>
          <div class="canvas-controls-right">
            <button id="exportDXF" class="btn" aria-label="Exporter le schéma au format DXF">Export DXF</button>
            <button id="clear" class="btn" aria-label="Vider complètement le canvas">Tout vider</button>
          </div>
        </div>
        <div class="canvas-controls-row">
          <div class="mouse-actions-cards">
            <div class="mouse-card" role="img" aria-label="Clic gauche pour sélectionner">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Clic gauche de souris</title>
                <rect x="5" y="3" width="14" height="18" rx="7" fill="#4b5563" />
                <rect x="9" y="5" width="6" height="6" rx="3" fill="#374151" />
                <path d="M5 9h7V3a7 7 0 0 0-7 6z" fill="#ef4444" />
              </svg>
              <span>Sélection</span>
            </div>
            <div class="mouse-card" role="img" aria-label="Clic droit pour placer">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Clic droit de souris</title>
                <rect x="5" y="3" width="14" height="18" rx="7" fill="#4b5563" />
                <rect x="9" y="5" width="6" height="6" rx="3" fill="#374151" />
                <path d="M12 3v6h7a7 7 0 0 0-7-6z" fill="#ef4444" />
              </svg>
              <span>Placer</span>
            </div>
          </div>
          <div class="card">
            <div class="small">
              Sélection/déplacement&nbsp;: clic gauche (glisser). Placer&nbsp;: clic droit. Supprimer&nbsp;: Suppr ou bouton.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="toast" class="toast">Impossible de placer l'élément ici.</div>
  <script src="script.js" defer></script>
  <script src="dimension-button-handler.js" defer></script>
  
  <!-- PWA Service Worker -->
  <script>
    (function initPWA() {
      'use strict';
      
      if (!('serviceWorker' in navigator)) {
        console.warn('⚠️ Service Worker non supporté par ce navigateur');
        return;
      }

      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then((registration) => {
            console.log('✅ Service Worker TontonKAD enregistré:', registration.scope);
            
            // Gérer les mises à jour du service worker
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (!newWorker) return;
              
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Nouvelle version disponible
                  const shouldUpdate = confirm('🔄 Une nouvelle version de TontonKAD est disponible. Recharger maintenant ?');
                  if (shouldUpdate) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.error('❌ Erreur lors de l\'enregistrement du Service Worker:', error);
            // Fallback silencieux - l'application fonctionne sans PWA
          });
      });

      // Gérer les mises à jour automatiques
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('🔄 Service Worker mis à jour, rechargement...');
        window.location.reload();
      });
    })();

    // Gestion de l'installation PWA
    (function initPWAInstall() {
      'use strict';
      
      let deferredPrompt = null;
      
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        
        // Créer un bouton d'installation
        const installButton = document.createElement('div');
        installButton.className = 'rainbow-button';
        installButton.setAttribute('role', 'button');
        installButton.setAttribute('tabindex', '0');
        installButton.setAttribute('aria-label', 'Installer TontonKAD comme application');
        installButton.style.cssText = `
          position: absolute; 
          top: 20px; 
          right: 20px; 
          z-index: 1000;
          box-shadow: 0 4px 16px rgba(0,0,0,0.3);
          width: auto;
        `;
        
        // Créer le bouton intérieur
        const innerButton = document.createElement('button');
        innerButton.className = 'rainbow-button-inner';
        innerButton.textContent = '📱 Installer TontonKAD';
        innerButton.setAttribute('aria-label', 'Installer l\'application TontonKAD');
        
        installButton.appendChild(innerButton);
        
        // L'ajouter à la section canvas
        const canvasSection = document.querySelector('.canvas-section');
        if (canvasSection) {
          canvasSection.appendChild(installButton);
        }
        
        // Gestionnaire d'événement pour l'installation
        const handleInstall = () => {
          if (!deferredPrompt) return;
          
          installButton.style.display = 'none';
          deferredPrompt.prompt();
          
          deferredPrompt.userChoice
            .then((result) => {
              console.log('Choix installation PWA:', result.outcome);
              deferredPrompt = null;
            })
            .catch((error) => {
              console.error('Erreur lors de l\'installation PWA:', error);
            });
        };
        
        innerButton.addEventListener('click', handleInstall);
        
        // Support clavier
        installButton.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleInstall();
          }
        });
      });

      // Cacher le bouton après installation
      window.addEventListener('appinstalled', () => {
        console.log('🎉 TontonKAD installé avec succès !');
        const installButton = document.querySelector('.rainbow-button');
        if (installButton) {
          installButton.remove();
        }
        deferredPrompt = null;
      });
    })();
  </script>

  <!-- Popup d'édition -->
  <div id="editPopup" class="edit-popup" style="display: none;" role="dialog" aria-labelledby="editPopupTitle" aria-modal="true">
    <div class="edit-popup-content">
      <h3 id="editPopupTitle">Éditer l'objet</h3>
      <div class="edit-field">
        <label for="editLabel">Libellé/Commentaire :</label>
        <input type="text" id="editLabel" placeholder="Entrez un libellé..." aria-describedby="editLabelHelp">
        <small id="editLabelHelp" class="sr-only">Ajoutez un libellé descriptif pour cet objet</small>
      </div>
      <div class="edit-field">
        <label for="editColor">Couleur personnalisée :</label>
        <input type="color" id="editColor" aria-describedby="editColorHelp">
        <button id="resetColor" type="button" aria-label="Rétablir la couleur par défaut">Couleur par défaut</button>
        <small id="editColorHelp" class="sr-only">Choisissez une couleur personnalisée pour cet objet</small>
      </div>
      <div class="edit-buttons">
        <button id="saveEdit" type="button" aria-label="Sauvegarder les modifications">Sauvegarder</button>
        <button id="cancelEdit" type="button" aria-label="Annuler les modifications">Annuler</button>
      </div>
    </div>
    <div class="edit-popup-overlay" aria-hidden="true"></div>
  </div>

</body></html>
