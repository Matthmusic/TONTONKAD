<!DOCTYPE html>
<html lang="fr" data-theme="light">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no"/>
    <title>TontonKAD v2 - Organisateur de Fourreaux & C√¢bles</title>
    <meta name="description" content="Application web pour organiser fourreaux et c√¢bles √©lectriques - Calcul d'occupation et visualisation 2D - Th√®me CEA"/>
    <meta name="keywords" content="fourreaux, c√¢bles, √©lectricit√©, organisation, calcul, visualisation, CEA"/>
    <meta name="author" content="TontonKAD"/>

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website"/>
    <meta property="og:title" content="TontonKAD v2 - Organisateur de Fourreaux & C√¢bles"/>
    <meta property="og:description" content="Application web pour organiser fourreaux et c√¢bles √©lectriques - Nouvelle interface CEA"/>
    <meta property="og:image" content="TONTONKAD.svg"/>

    <!-- Security - Electron CSP -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self' data:"/>

    <link id="favicon" rel="icon" type="image/x-icon" href="../../assets/icons/ico/TONTONKADN.ico"/>

    <!-- Font Awesome 6 (local) -->
    <link rel="stylesheet" href="../../assets/fonts/fontawesome-free-6.5.1-web/css/all.min.css"/>

    <!-- Styles -->
    <link rel="stylesheet" href="style.css"/>

    <!-- PWA Configuration -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff914d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="TontonKAD v2">
    <link rel="apple-touch-icon" href="TONTONKAD.svg">

    <!-- Pr√©chargement des ressources critiques -->
    <link rel="preload" href="script.js" as="script">

    <!-- jsPDF pour l'export PDF -->
    <script src="jspdf.min.js"></script>
</head>
<body>
  <!-- Custom Titlebar (Electron seulement) -->
  <div id="custom-titlebar" class="custom-titlebar">
    <div class="titlebar-drag-region">
      <div class="titlebar-left">
        <img id="titlebar-logo" src="../../assets/icons/ico/TONTONKADN.png" alt="TONTONKAD Logo" class="titlebar-logo">
        <span class="titlebar-title">TONTONKAD v2</span>
      </div>
      <div class="titlebar-center"></div>
      <div class="titlebar-right">
        <!-- Toggle th√®me dans la titlebar -->
        <button id="titlebar-theme-toggle" class="titlebar-button titlebar-theme-btn" title="Changer de th√®me">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="5"/>
            <line x1="12" y1="1" x2="12" y2="3"/>
            <line x1="12" y1="21" x2="12" y2="23"/>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
            <line x1="1" y1="12" x2="3" y2="12"/>
            <line x1="21" y1="12" x2="23" y2="12"/>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
          </svg>
        </button>
        <!-- Boutons de contr√¥le -->
        <button id="titlebar-minimize" class="titlebar-button" title="Minimiser">
          <svg width="12" height="12" viewBox="0 0 12 12">
            <rect x="0" y="5" width="12" height="2" fill="currentColor"/>
          </svg>
        </button>
        <button id="titlebar-maximize" class="titlebar-button" title="Agrandir/Restaurer">
          <svg width="12" height="12" viewBox="0 0 12 12">
            <rect x="1" y="1" width="10" height="10" stroke="currentColor" stroke-width="1.5" fill="none"/>
          </svg>
        </button>
        <button id="titlebar-close" class="titlebar-button titlebar-close" title="Fermer">
          <svg width="12" height="12" viewBox="0 0 12 12">
            <path d="M1,1 L11,11 M11,1 L1,11" stroke="currentColor" stroke-width="1.5"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Notification de mise √† jour -->
  <div id="update-notification" class="update-notification hidden">
    <div class="update-notification-content">
      <div class="update-notification-header">
        <div class="update-icon">üöÄ</div>
        <h3>Mise √† jour disponible</h3>
      </div>
      <div class="update-notification-body">
        <p class="update-version">Version <strong id="update-version-number">0.0.0</strong> est disponible</p>
        <p class="update-description" id="update-description">Une nouvelle version de TONTONKAD est disponible avec des am√©liorations et corrections.</p>
        <div class="update-progress hidden" id="update-progress-container">
          <div class="update-progress-bar">
            <div class="update-progress-fill" id="update-progress-fill"></div>
          </div>
          <p class="update-progress-text" id="update-progress-text">T√©l√©chargement en cours...</p>
        </div>
      </div>
      <div class="update-notification-footer">
        <button class="update-btn update-btn-secondary" id="update-btn-later">Plus tard</button>
        <button class="update-btn update-btn-primary" id="update-btn-download">T√©l√©charger maintenant</button>
      </div>
    </div>
  </div>

  <!-- Modal de configuration de la base de donn√©es -->
  <div id="settings-modal" class="update-notification hidden">
    <div class="update-notification-content">
      <div class="update-notification-header">
        <div class="update-icon">‚öôÔ∏è</div>
        <h3>Param√®tres de la base de donn√©es</h3>
      </div>
      <div class="update-notification-body">
        <p class="update-description">Choisissez l'emplacement des fichiers CSV (c√¢bles, fourreaux, chemins de c√¢ble).</p>

        <div style="margin-top: 20px;">
          <label style="display: block; margin-bottom: 10px; font-weight: 600;">
            <input type="radio" name="data-location" id="radio-default" checked style="margin-right: 8px;">
            Utiliser le dossier local (APPDATA)
          </label>
          <div id="default-path-info" style="margin-left: 28px; margin-bottom: 16px; font-size: 12px; color: var(--text-secondary);"></div>

          <label style="display: block; margin-bottom: 10px; font-weight: 600;">
            <input type="radio" name="data-location" id="radio-custom" style="margin-right: 8px;">
            Utiliser un dossier personnalis√© (r√©seau ou local)
          </label>
          <div id="custom-path-container" style="margin-left: 28px; margin-top: 12px; display: none;">
            <div style="display: flex; gap: 8px; align-items: center;">
              <input type="text" id="custom-path-input" readonly
                     style="flex: 1; padding: 8px 12px; background: var(--input-bg); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-primary);"
                     placeholder="S√©lectionner un dossier...">
              <button id="browse-folder-btn" class="update-btn update-btn-secondary" style="padding: 8px 16px; min-width: auto;">
                üìÅ Parcourir
              </button>
            </div>
            <p style="margin-top: 8px; font-size: 12px; color: var(--text-secondary);">
              Exemple: <code style="background: var(--glass-bg); padding: 2px 6px; border-radius: 4px;">Z:\F - UTILITAIRES\TONTONKAD\DATABASE</code>
            </p>
          </div>
        </div>

        <div id="settings-status" style="margin-top: 16px; padding: 12px; border-radius: 8px; display: none;"></div>
      </div>
      <div class="update-notification-footer">
        <button class="update-btn update-btn-secondary" id="settings-cancel-btn">Annuler</button>
        <button class="update-btn update-btn-primary" id="settings-save-btn">Enregistrer</button>
      </div>
    </div>
  </div>

  <div class="wrap">
    <aside class="panel">
      <div class="panel-resize-handle"></div>
      <div class="brand">
        <img id="brandLogo" src="../../assets/icons/ico/TONTONKADN.png" class="logo" alt="Logo TontonKAD" />
        <h1>Organisateur de Fourreaux & C√¢bles</h1>
      </div>
      <div class="panel-controls">
        <div class="row">
          <label for="shape">Forme de la bo√Æte</label>
          <select id="shape">
            <option value="rect">Bo√Æte rectangulaire</option>
            <option value="circ">Conduit circulaire</option>
            <option value="chemin_de_cable">Chemin de c√¢ble</option>
          </select>
        </div>
        <div id="rectInputs">
          <div class="row-inline">
            <div class="inline-input">
              <label for="boxW">Largeur (mm)</label>
              <div class="input-lock-group">
                <input id="boxW" type="number" step="0.1" min="0" value="1000" />
                <span class="lock-icon" data-target="lockWidth">
                  <img src="../../assets/icons/ico/cadenas-ouvert.ico" alt="Cadenas" class="cadenas-icon">
                  <input type="checkbox" id="lockWidth" style="display: none;" />
                </span>
              </div>
            </div>
            <div class="inline-input">
              <label for="boxH">Hauteur (mm)</label>
              <div class="input-lock-group">
                <input id="boxH" type="number" step="0.1" min="0" value="1000" />
                <span class="lock-icon" data-target="lockHeight">
                  <img src="../../assets/icons/ico/cadenas-ouvert.ico" alt="Cadenas" class="cadenas-icon">
                  <input type="checkbox" id="lockHeight" style="display: none;" />
                </span>
              </div>
            </div>
          </div>
          <div class="apply-dimensions-container">
            <button id="apply" class="btn apply-btn hidden" aria-label="Appliquer les nouvelles dimensions - Raccourci: Entr√©e">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Appliquer les dimensions</title>
                <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span class="apply-text">Appliquer dimensions</span>
            </button>
          </div>
        </div>
        <div id="circInputs" class="hidden">
          <div class="row">
            <label for="boxD">Diam√®tre (mm)</label>
            <input id="boxD" type="number" step="0.1" min="0" value="1000" />
          </div>
          <div class="apply-dimensions-container">
            <button id="applyCirc" class="btn apply-btn hidden" aria-label="Appliquer les nouvelles dimensions - Raccourci: Entr√©e">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Appliquer les dimensions</title>
                <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span class="apply-text">Appliquer dimensions</span>
            </button>
          </div>
        </div>
        <div class="card hidden">
          <div class="row">
            <label for="targetPxPerMm">√âchelle cible (px/mm)</label>
            <input id="targetPxPerMm" type="number" step="0.01" value="1.00" />
          </div>
        </div>
        <div class="card">
          <div class="tabs">
            <div id="tabFOURREAU" class="tab active">FOURREAU</div>
            <div id="tabCABLE" class="tab">C√ÇBLE</div>
          </div>
          <div id="paneFOURREAU">
            <div class="row">
              <label for="fourreauSelect">Type de Fourreau</label>
              <div class="searchable-select-container">
                <input type="text" id="fourreauSearch" class="searchable-input" placeholder="Taper pour rechercher un fourreau..." autocomplete="off" role="combobox" aria-haspopup="listbox" aria-expanded="false" aria-controls="fourreauSelect">
                <div id="fourreauSelect" class="searchable-list" role="listbox">
                </div>
              </div>
            </div>
            <div class="small">
              Le Fourreau est un <b>anneau</b>¬†:
              <span class="pill">√ò ext = code</span>,
              <span class="pill">√ò int ‚â• liste</span>.
            </div>
          </div>
          <div id="paneCABLE" class="hidden">
            <div class="row">
              <label for="cableSelect">Type de C√¢ble</label>
              <div class="searchable-select-container">
                <input type="text" id="cableSearch" class="searchable-input" placeholder="Taper pour rechercher un c√¢ble..." autocomplete="off" role="combobox" aria-haspopup="listbox" aria-expanded="false" aria-controls="cableSelect">
                <div id="cableSelect" class="searchable-list" role="listbox">
                </div>
              </div>
            </div>
            <div class="small">
              Un C√¢ble est <b>plein</b>, contr√¥le √ò si dans un Fourreau.
            </div>
          </div>
        </div>
        <div class="two-cols">
          <div class="card listwrap">
            <div class="headerline">
              <b>Inventaire Fourreaux</b>
              <span class="muted">
                Objets: <span id="countInvF">0</span> ‚Ä¢ Types:
                <span id="typesInvF">0</span>
              </span>
            </div>
            <input
              id="searchFourreau"
              class="search"
              placeholder="Rechercher Fourreau (type, code)‚Ä¶"
            />
            <div
              id="listFourreau"
              class="list"
              role="listbox"
              aria-label="Inventaire Fourreaux"
            ></div>
            <div class="small">
              1 ligne par type (√ó quantit√©). Clique pour s√©lectionner un
              exemplaire, double‚Äëclic pour passer au suivant.
            </div>
          </div>
          <div class="card listwrap">
            <div class="headerline">
              <b>Inventaire C√¢bles</b>
              <span class="muted">
                Objets: <span id="countInvC">0</span> ‚Ä¢ Types:
                <span id="typesInvC">0</span>
              </span>
            </div>
            <input
              id="searchCable"
              class="search"
              placeholder="Rechercher C√ÇBLE (famille, code)‚Ä¶"
            />
            <div
              id="listCable"
              class="list"
              role="listbox"
              aria-label="Inventaire C√ÇBLES"
            ></div>
            <div class="small">
              1 ligne par type (√ó quantit√©). Clique pour s√©lectionner un
              exemplaire, double‚Äëclic pour passer au suivant.
            </div>
          </div>
        </div>
        <div class="card">
          <b>D√©tails s√©lection</b>
          <div id="selInfo" class="info-list muted">
            Aucun objet s√©lectionn√©.
          </div>
        </div>
      </div>
      
      <div class="panel-stats">
        <div class="card">
          <div class="row">
            <div>Total Fourreaux</div>
            <div class="kpi">
              <span id="statFourreau">0</span>
            </div>
          </div>
          <div class="row">
            <div>Total C√¢bles</div>
            <div class="kpi">
              <span id="statCable">0</span>
            </div>
          </div>
          <div class="row">
            <div>Taux d'occupation</div>
            <div class="kpi">
              <span id="statOccupation">0.0 %</span>
            </div>
          </div>
          <div class="row">
            <div>√âchelle d'affichage</div>
            <div>
              <span id="scaleInfo">‚Äî</span>
            </div>
          </div>
        </div>
      </div>
    </aside>
    <div class="canvas-section">
      <div class="main-view">
        <div class="main-view-content">
          <main class="canvas-wrap">
            <canvas id="world"></canvas>
            <!-- Cotes pour la largeur -->
            <div id="dimensionWidth" class="dimension-line horizontal" style="display: none;">
              <span class="dimension-text"></span>
            </div>
            <!-- Cotes pour la hauteur -->
            <div id="dimensionHeight" class="dimension-line vertical" style="display: none;">
              <span class="dimension-text"></span>
            </div>
            
            <!-- Bouton de r√©duction automatique -->
            <div id="reduceButtonContainer" class="reduce-button-container" style="display: none;">
              <button id="reduceToMinimum" class="btn reduce-btn">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <path d="M5 12h14M12 5l7 7-7 7" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                R√©duire au minimum
              </button>
            </div>
          </main>
          <!-- Zoom contr√¥l√© par Ctrl+molette dans le canvas -->
        </div>
      </div>
      <!-- Wrapper pour canvas-controls et project-controls -->
      <div class="canvas-project-controls-wrapper">
        <div class="canvas-controls">
          <!-- Ligne principale d'outils group√©s logiquement -->
          <div class="canvas-controls-row">
          <!-- Groupe 1: Actions d'√©dition et suppression -->
          <div class="control-group" data-group="edition">
            <div class="group-label">√âdition</div>
            <button id="toolEdit" class="btn" aria-label="Outil d'√©dition - Raccourci: E">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Ic√¥ne d'√©dition</title>
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="#e5f0ff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M18.5 2.5a2.12 2.12 0 0 1 3 3L12 15l-4 1 1-4z" stroke="#e5f0ff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              √âditer (E)
            </button>
            <button id="toolInfo" class="btn" aria-label="Outil d'information - Raccourci: I">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Ic√¥ne d'information</title>
                <circle cx="12" cy="12" r="10" stroke="#e5f0ff" stroke-width="2" fill="none"/>
                <path d="M9,9 h6 a3,3 0 0,1 0,6 h-6" stroke="#e5f0ff" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
                <line x1="12" y1="17" x2="12.01" y2="17" stroke="#e5f0ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Infos (I)
            </button>
            <button id="toolDelete" class="btn btn-danger" aria-label="Supprimer l'objet s√©lectionn√© - Raccourci: Suppr">Supprimer (Suppr)</button>
            <button id="clear" class="btn btn-warning" aria-label="Vider compl√®tement le canvas - Raccourci: Ctrl+Suppr">Tout vider (Ctrl+Suppr)</button>
          </div>

          <!-- Groupe 2: Organisation et arrangement -->
          <div class="control-group" data-group="arrangement">
            <div class="group-label">Organisation</div>
            <button id="gridArrange" class="btn" aria-label="Disposer les fourreaux en grille 3cm - Raccourci: Ctrl+G">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Ic√¥ne grille</title>
                <rect x="3" y="3" width="6" height="6" stroke="#e5f0ff" stroke-width="2" fill="none"/>
                <rect x="15" y="3" width="6" height="6" stroke="#e5f0ff" stroke-width="2" fill="none"/>
                <rect x="3" y="15" width="6" height="6" stroke="#e5f0ff" stroke-width="2" fill="none"/>
                <rect x="15" y="15" width="6" height="6" stroke="#e5f0ff" stroke-width="2" fill="none"/>
              </svg>
              Grille (Ctrl+G)
            </button>
            <button id="freezeBtn" class="btn" disabled aria-label="Figer l'objet s√©lectionn√© - Raccourci: G">Figer (G)</button>
          </div>
        </div>

        <!-- Ligne d'aide et raccourcis consolid√©e -->
        <div class="canvas-controls-help">
          <div class="help-section">
            <div class="keyboard-shortcuts">
              <strong>Raccourcis:</strong>
              <span class="shortcut mouse-action">
                Clic G: S√©lection/D√©placer
              </span>
              <span class="shortcut mouse-action">
                Clic D: Placer
              </span>
              <span class="shortcut">Ctrl+molette: Zoom</span>
              <span class="shortcut">Ctrl+Z: Annuler</span>
              <span class="shortcut">Suppr: Supprimer</span>
              <span class="shortcut">Ctrl+Suppr: Tout vider</span>
            </div>
          </div>
        </div>
      </div>

        <!-- Wrapper pour les contr√¥les de droite (PWA + Projet) -->
        <div class="right-controls-wrapper">
          <div class="project-controls-right control-group-vertical" data-group="project">
            <div class="group-label">Projet</div>
            <button id="projectSave" class="btn btn-primary" aria-label="Sauvegarder le projet - Raccourci: Ctrl+S">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <title>Sauvegarder</title>
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" stroke="currentColor" stroke-width="2" fill="none"/>
                <polyline points="17,21 17,13 7,13 7,21" stroke="currentColor" stroke-width="2" fill="none"/>
                <polyline points="7,3 7,8 15,8" stroke="currentColor" stroke-width="2" fill="none"/>
              </svg>
              Projets
            </button>
            <button id="exportDXF" class="btn" aria-label="Exporter le sch√©ma au format DXF">Export DXF</button>
            <button id="exportPDF" class="btn" aria-label="Exporter le sch√©ma au format PDF">Export PDF</button>
          </div>
        </div>
      </div>
      <div id="theme-switcher" class="theme-switcher" role="button" tabindex="0" aria-label="Changer de th√®me">
        <span class="icon-sun"><img src="../../assets/icons/ico/SUN.ico" alt="Sun" style="width: 16px; height: 16px;"></span>
        <span class="icon-moon"><img src="../../assets/icons/ico/MOON.ico" alt="Moon" style="width: 16px; height: 16px;"></span>
      </div>
      <div id="settings-button" class="settings-button" role="button" tabindex="0" aria-label="Ouvrir le dossier de donn√©es" title="Acc√©der aux fichiers CSV personnalisables">
        ‚öôÔ∏è
      </div>
      <div id="version-info" class="version-info" title="Version de l'application">
        <span id="version-number">v2.0.1</span>
      </div>
  </div>
  <div id="toast" class="toast">Impossible de placer l'√©l√©ment ici.</div>
  <script src="script.js" defer></script>
  <script src="dimension-button-handler.js" defer></script>

  <!-- Popup d'√©dition -->
  <div id="editPopup" class="edit-popup" style="display: none;" role="dialog" aria-labelledby="editPopupTitle" aria-modal="true">
    <div class="edit-popup-overlay" aria-hidden="true">
      <div class="edit-popup-content">
        <h3 id="editPopupTitle">√âditer l'objet</h3>
        <div class="edit-field">
          <label for="editLabel">Libell√©/Commentaire :</label>
          <input type="text" id="editLabel" placeholder="Entrez un libell√©..." aria-describedby="editLabelHelp">
          <small id="editLabelHelp" class="sr-only">Ajoutez un libell√© descriptif pour cet objet</small>
        </div>
        <div class="edit-field">
          <label for="editColor">Couleur personnalis√©e :</label>
          <div class="color-controls">
            <input type="color" id="editColor" aria-describedby="editColorHelp">
            <div class="color-dropdown">
              <button id="autocadColorBtn" type="button" class="autocad-color-btn" aria-label="Choisir une couleur AutoCAD">
                <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                  <rect x="2" y="2" width="20" height="20" rx="2" fill="none" stroke="currentColor" stroke-width="2"/>
                  <rect x="6" y="6" width="3" height="3" fill="#ff0000"/>
                  <rect x="10.5" y="6" width="3" height="3" fill="#00ff00"/>
                  <rect x="15" y="6" width="3" height="3" fill="#0000ff"/>
                  <rect x="6" y="10.5" width="3" height="3" fill="#ffff00"/>
                  <rect x="10.5" y="10.5" width="3" height="3" fill="#ff00ff"/>
                  <rect x="15" y="10.5" width="3" height="3" fill="#00ffff"/>
                  <rect x="6" y="15" width="3" height="3" fill="#ffffff" stroke="#666"/>
                  <rect x="10.5" y="15" width="3" height="3" fill="#808080"/>
                  <rect x="15" y="15" width="3" height="3" fill="#000000"/>
                </svg>
                Couleurs AutoCAD
              </button>
              <div id="colorDropdown" class="color-dropdown-content">
                <div id="colorGrid" class="color-grid">
                  <!-- Grille g√©n√©r√©e dynamiquement -->
                </div>
              </div>
            </div>
            <button id="resetColor" type="button" aria-label="R√©tablir la couleur par d√©faut">Couleur par d√©faut</button>
          </div>
          <small id="editColorHelp" class="sr-only">Choisissez une couleur personnalis√©e avec la pipette ou la palette AutoCAD</small>
        </div>
        <div id="cablePhaseSection" class="edit-field" style="display: none;">
          <label>Conducteur unifilaire :</label>
          <div class="phase-checkboxes">
            <div class="phase-option">
              <input type="radio" id="phase-none" name="cablePhase" data-phase="none" checked>
              <label for="phase-none">
                <span class="phase-color" style="background-color: #666666;"></span>
                Aucun (couleur par d√©faut)
              </label>
            </div>
            <div class="phase-option">
              <input type="radio" id="phase-ph1" name="cablePhase" data-phase="ph1">
              <label for="phase-ph1">
                <span class="phase-color" style="background-color: #8B4513;"></span>
                L1 (Marron)
              </label>
            </div>
            <div class="phase-option">
              <input type="radio" id="phase-ph2" name="cablePhase" data-phase="ph2">
              <label for="phase-ph2">
                <span class="phase-color" style="background-color: #808080;"></span>
                L2 (Gris)
              </label>
            </div>
            <div class="phase-option">
              <input type="radio" id="phase-ph3" name="cablePhase" data-phase="ph3">
              <label for="phase-ph3">
                <span class="phase-color" style="background-color: #000000;"></span>
                L3 (Noir)
              </label>
            </div>
            <div class="phase-option">
              <input type="radio" id="phase-n" name="cablePhase" data-phase="n">
              <label for="phase-n">
                <span class="phase-color" style="background-color: #0000FF;"></span>
                N (Bleu)
              </label>
            </div>
            <div class="phase-option">
              <input type="radio" id="phase-pe" name="cablePhase" data-phase="pe">
              <label for="phase-pe">
                <span class="phase-color" style="background-color: #00FF00;"></span>
                PE (Vert fluo)
              </label>
            </div>
          </div>
        </div>
        <!-- Section pour le remplissage rapide des fourreaux -->
        <div id="fourreauFillSection" class="edit-field" style="display: none;">
          <label>Remplissage rapide du fourreau</label>
          <div class="fill-controls">
              <select id="fillCableSelect" aria-label="S√©lectionner le type de c√¢ble unipolaire"></select>
              <div class="fill-buttons">
                  <button id="fillTetra" type="button">T√©trapolaire (L1,L2,L3,N,PE)</button>
                  <button id="fillTri" type="button">Triphas√© (L1,L2,L3,N)</button>
              </div>
          </div>
          <small>Attention : ceci remplacera les c√¢bles existants dans le fourreau.</small>
        </div>
        <div class="edit-buttons">
          <button id="saveEdit" type="button" aria-label="Sauvegarder les modifications">Sauvegarder</button>
          <button id="cancelEdit" type="button" aria-label="Annuler les modifications">Annuler</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Popup de proposition de redimensionnement -->
  <div id="resizePopup" class="edit-popup" style="display: none;" role="dialog" aria-labelledby="resizePopupTitle" aria-modal="true">
    <div class="edit-popup-content">
      <h3 id="resizePopupTitle">Ajustement n√©cessaire</h3>
      <div class="edit-field">
        <p id="resizeMessage"></p>
      </div>
      <div class="edit-buttons">
        <button id="applyResize" type="button">Appliquer</button>
        <button id="cancelResize" type="button">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Popup de gestion des projets -->
  <div id="projectModal" class="edit-popup" style="display: none;" role="dialog" aria-labelledby="projectModalTitle" aria-modal="true">
    <div class="edit-popup-overlay" aria-hidden="true">
      <div class="edit-popup-content project-modal-content">
      <!-- Header -->
      <div class="modal-header">
        <h3 id="projectModalTitle">üóÇÔ∏è Gestion des Projets</h3>
      </div>

      <!-- Section Projets unifi√©e -->
      <div class="projects-section">

        <!-- Sauvegarde projet actuel -->
        <div class="project-save">
          <h4>üíæ Sauvegarder le projet actuel</h4>
          <div class="project-field">
            <select id="projectFolder" class="project-folder-select">
              <option value="">üè† Racine (sans dossier)</option>
            </select>
            <input type="text" id="newProjectName" placeholder="Nom du projet..." maxlength="50" list="existingProjects">
            <datalist id="existingProjects"></datalist>
            <button id="saveNewProject" type="button" class="btn-primary">Sauvegarder</button>
          </div>
        </div>

        <!-- Projets sauvegard√©s -->
        <div class="projects-list-section">
          <div class="projects-header">
            <h4>üìÇ Projets sauvegard√©s</h4>
            <button id="toggleFolderCreation" type="button" class="btn-secondary btn-compact">+ Cr√©er un dossier</button>
          </div>
          <div id="folderCreationField" class="folder-field" style="display: none;">
            <input type="text" id="newFolderName" placeholder="Nom du dossier (ex: Port de Cannes)..." maxlength="50">
            <button id="createNewFolder" type="button" class="btn-primary">Cr√©er</button>
            <button id="cancelFolderCreation" type="button" class="btn-cancel">Annuler</button>
          </div>
          <div id="projectsList" class="projects-list">
            <!-- Sera rempli dynamiquement -->
          </div>
        </div>
      </div>

      <!-- Section auto-save -->
      <div class="auto-save-section" id="autoSaveSection">
        <div class="auto-save-info">
          <div class="auto-save-status" id="autoSaveStatus">
            <span class="icon">üíæ</span>
            <span class="text" id="autoSaveText">Aucune auto-sauvegarde</span>
          </div>
          <button id="restoreAutoSave" type="button" class="btn-secondary btn-compact" style="display: none;">Restaurer</button>
        </div>
        <div class="auto-save-details" id="autoSaveDetails"></div>
      </div>

      <!-- √âl√©ments cach√©s pour fonctionnalit√© existante -->
      <button id="exportCurrentProject" type="button" style="display: none;">Export actuel</button>
      <button id="importProject" type="button" style="display: none;">Import</button>
      <input type="file" id="importProjectFile" accept=".tontonkad,.json" style="display: none;">

      </div> <!-- Fin de project-modal-content -->
    </div> <!-- Fin de edit-popup-overlay -->
  </div>

  <!-- Popup de renommage -->
  <div id="renameModal" class="edit-popup" style="display: none;" role="dialog" aria-labelledby="renameModalTitle" aria-modal="true">
    <div class="edit-popup-overlay" aria-hidden="true">
      <div class="edit-popup-content rename-modal-content">
      <div class="modal-header">
        <h3 id="renameModalTitle">‚úèÔ∏è Renommer le projet</h3>
      </div>

      <div class="rename-form">
        <div class="rename-info">
          <span class="current-name-label">Nom actuel :</span>
          <span id="currentProjectName" class="current-name">Mon Projet</span>
        </div>

        <div class="project-field">
          <label for="newProjectNameInput">Nouveau nom :</label>
          <input type="text" id="newProjectNameInput" placeholder="Entrez le nouveau nom..." maxlength="50">
        </div>

        <div class="rename-actions">
          <button id="confirmRename" type="button" class="btn-primary">‚úì Confirmer</button>
          <button id="cancelRename" type="button" class="btn-cancel">‚úï Annuler</button>
        </div>
      </div> <!-- Fin de rename-modal-content -->
    </div> <!-- Fin de edit-popup-overlay -->
  </div>

  <!-- Modal Export PDF -->
  <div id="pdfExportModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>üéØ Export PDF - Configuration</h3>
        <button class="modal-close" onclick="closePdfExportModal()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="export-form">
          <div class="form-group">
            <label for="pdfProjectName">Nom du projet :</label>
            <input type="text" id="pdfProjectName" placeholder="Mon projet TontonKAD" maxlength="50">
          </div>

          <div class="form-group">
            <label for="pdfViewName">Nom de la vue :</label>
            <input type="text" id="pdfViewName" placeholder="Vue principale" maxlength="50">
          </div>

          <div class="form-group">
            <label for="pdfAuthor">Auteur :</label>
            <input type="text" id="pdfAuthor" placeholder="Votre nom" maxlength="50">
          </div>

          <div class="form-group">
            <label for="pdfClient">Client :</label>
            <input type="text" id="pdfClient" placeholder="Nom du client" maxlength="50">
          </div>

          <div class="form-group">
            <label for="pdfDescription">Description :</label>
            <textarea id="pdfDescription" placeholder="Description du projet..." maxlength="200" rows="3"></textarea>
          </div>

          <div class="form-group">
            <label for="pdfIncludeStats">
              <input type="checkbox" id="pdfIncludeStats" checked>
              Inclure les statistiques d√©taill√©es
            </label>
          </div>
        </div>
      </div>

      <div class="modal-actions">
        <button id="confirmPdfExport" type="button" class="btn-primary">üìÑ G√©n√©rer PDF</button>
        <button id="cancelPdfExport" type="button" class="btn-cancel">‚úï Annuler</button>
      </div>
    </div>
  </div>
  
  <!-- PWA Service Worker -->
  <script>
    (function initPWA() {
      'use strict';

      // Skip Service Worker en mode Electron - on utilise electron-updater √† la place
      if (window.electronAPI && window.electronAPI.isElectron) {
        console.log('Mode Electron: Service Worker d√©sactiv√© (electron-updater actif)');
        return;
      }

      if (!('serviceWorker' in navigator)) {
        console.warn('‚ö†Ô∏è Service Worker non support√© par ce navigateur');
        return;
      }

      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./sw.js')
          .then((registration) => {

            // G√©rer les mises √† jour du service worker
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              if (!newWorker) return;

              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // Nouvelle version disponible
                  const shouldUpdate = confirm('üîÑ Une nouvelle version de TontonKAD est disponible. Recharger maintenant ?');
                  if (shouldUpdate) {
                    newWorker.postMessage({ type: 'SKIP_WAITING' });
                    window.location.reload();
                  }
                }
              });
            });
          })
          .catch((error) => {
            console.error('‚ùå Erreur lors de l\'enregistrement du Service Worker:', error);
            // Fallback silencieux - l'application fonctionne sans PWA
          });
      });

      // G√©rer les mises √† jour automatiques
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        window.location.reload();
      });
    })();

    // Gestion de l'installation PWA
    (function initPWAInstall() {
      'use strict';

      // Skip PWA install en mode Electron
      if (window.electronAPI && window.electronAPI.isElectron) {
        return;
      }

      let deferredPrompt = null;

      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;

        // V√©rifier si le bouton existe d√©j√†
        if (document.querySelector('.rainbow-button')) {
          return; // Ne pas cr√©er de doublon
        }

        // Cr√©er un bouton d'installation
        const installButton = document.createElement('div');
        installButton.className = 'rainbow-button';
        installButton.setAttribute('role', 'button');
        installButton.setAttribute('tabindex', '0');
        installButton.setAttribute('aria-label', 'Installer TontonKAD comme application');

        // Cr√©er le bouton int√©rieur
        const innerButton = document.createElement('button');
        innerButton.className = 'rainbow-button-inner';
        innerButton.textContent = 'üì± Installer TontonKAD';
        innerButton.setAttribute('aria-label', 'Installer l\'application TontonKAD');

        installButton.appendChild(innerButton);

        // L'ajouter au-dessus de project-controls-right
        const rightControlsWrapper = document.querySelector('.right-controls-wrapper');
        if (rightControlsWrapper) {
          rightControlsWrapper.insertBefore(installButton, rightControlsWrapper.firstChild);
        }
        
        // Gestionnaire d'√©v√©nement pour l'installation
        const handleInstall = () => {
          if (!deferredPrompt) return;
          
          installButton.style.display = 'none';
          deferredPrompt.prompt();
          
          deferredPrompt.userChoice
            .then((result) => {
              deferredPrompt = null;
            })
            .catch((error) => {
              console.error('Erreur lors de l\'installation PWA:', error);
            });
        };
        
        innerButton.addEventListener('click', handleInstall);
        
        // Support clavier
        installButton.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            handleInstall();
          }
        });
      });

      // Cacher le bouton apr√®s installation
      window.addEventListener('appinstalled', () => {
        const installButton = document.querySelector('.rainbow-button');
        if (installButton) {
          installButton.remove();
        }
        deferredPrompt = null;
      });
    })();
  </script>

  <!-- Theme Toggle Script (theme-switcher) -->
  <script>
    // Fonction pour mettre √† jour le logo et le favicon selon le th√®me
    function updateLogo(theme) {
      const brandLogo = document.getElementById('brandLogo');
      const favicon = document.getElementById('favicon');

      if (brandLogo) {
        brandLogo.src = theme === 'dark' ? '../../assets/icons/ico/TONTONKADB.png' : '../../assets/icons/ico/TONTONKADN.png';
      }

      if (favicon) {
        favicon.href = theme === 'dark' ? '../../assets/icons/ico/TONTONKADB.ico' : '../../assets/icons/ico/TONTONKADN.ico';
      }
    }

  </script>

  <!-- Settings Button and Modal Script -->
  <script>
    // G√©rer le clic sur le bouton param√®tres (Electron uniquement)
    document.addEventListener('DOMContentLoaded', async () => {
      const settingsButton = document.getElementById('settings-button');
      const settingsModal = document.getElementById('settings-modal');
      const radioDefault = document.getElementById('radio-default');
      const radioCustom = document.getElementById('radio-custom');
      const customPathContainer = document.getElementById('custom-path-container');
      const customPathInput = document.getElementById('custom-path-input');
      const browseFolderBtn = document.getElementById('browse-folder-btn');
      const defaultPathInfo = document.getElementById('default-path-info');
      const settingsCancelBtn = document.getElementById('settings-cancel-btn');
      const settingsSaveBtn = document.getElementById('settings-save-btn');
      const settingsStatus = document.getElementById('settings-status');

      if (!window.electronAPI || !window.electronAPI.getConfig) {
        if (settingsButton) settingsButton.style.display = 'none';
        return;
      }

      let currentConfig = null;

      // Charger la configuration actuelle
      async function loadCurrentConfig() {
        try {
          currentConfig = await window.electronAPI.getConfig();
          defaultPathInfo.textContent = currentConfig.defaultDataFolder;

          if (currentConfig.useCustomPath) {
            radioCustom.checked = true;
            customPathContainer.style.display = 'block';
            customPathInput.value = currentConfig.dataPath;
          } else {
            radioDefault.checked = true;
            customPathContainer.style.display = 'none';
          }
        } catch (error) {
          console.error('Erreur lors du chargement de la config:', error);
        }
      }

      // Ouvrir la modal
      settingsButton.addEventListener('click', async () => {
        await loadCurrentConfig();
        settingsModal.classList.remove('hidden');
        settingsStatus.style.display = 'none';
      });

      // Fermer la modal
      settingsCancelBtn.addEventListener('click', () => {
        settingsModal.classList.add('hidden');
      });

      // Toggle custom path container
      radioDefault.addEventListener('change', () => {
        if (radioDefault.checked) {
          customPathContainer.style.display = 'none';
        }
      });

      radioCustom.addEventListener('change', () => {
        if (radioCustom.checked) {
          customPathContainer.style.display = 'block';
        }
      });

      // Parcourir les dossiers
      browseFolderBtn.addEventListener('click', async () => {
        try {
          const result = await window.electronAPI.selectFolder();
          if (result.success) {
            customPathInput.value = result.path;
          }
        } catch (error) {
          console.error('Erreur lors de la s√©lection du dossier:', error);
        }
      });

      // Sauvegarder la configuration
      settingsSaveBtn.addEventListener('click', async () => {
        try {
          settingsSaveBtn.disabled = true;
          settingsSaveBtn.textContent = 'Enregistrement...';

          let result;
          if (radioCustom.checked) {
            const customPath = customPathInput.value.trim();
            if (!customPath) {
              showStatus('Veuillez s√©lectionner un dossier', 'error');
              return;
            }
            result = await window.electronAPI.setDataPath(customPath);
          } else {
            result = await window.electronAPI.resetDataPath();
          }

          if (result.success) {
            showStatus(`Configuration enregistr√©e ! Dossier actif : ${result.path}`, 'success');
            setTimeout(() => {
              settingsModal.classList.add('hidden');
              // Recharger la page pour utiliser la nouvelle base de donn√©es
              window.location.reload();
            }, 2000);
          } else {
            showStatus(`Erreur : ${result.error}`, 'error');
          }
        } catch (error) {
          console.error('Erreur lors de la sauvegarde:', error);
          showStatus(`Erreur : ${error.message}`, 'error');
        } finally {
          settingsSaveBtn.disabled = false;
          settingsSaveBtn.textContent = 'Enregistrer';
        }
      });

      function showStatus(message, type) {
        settingsStatus.textContent = message;
        settingsStatus.style.display = 'block';
        settingsStatus.style.background = type === 'success' ? 'var(--success-bg)' : 'var(--error-bg)';
        settingsStatus.style.color = type === 'success' ? 'var(--success-color)' : 'var(--error-color)';
      }
    });
  </script>

  <!-- Custom Titlebar Script -->
  <script>
    // Initialiser la custom titlebar (Electron uniquement)
    document.addEventListener('DOMContentLoaded', () => {
      if (window.electronAPI && window.electronAPI.isElectron) {
        // Ajouter la classe electron-mode au body
        document.body.classList.add('electron-mode');

        const titlebarLogo = document.getElementById('titlebar-logo');
        const titlebarThemeToggle = document.getElementById('titlebar-theme-toggle');
        const minimizeBtn = document.getElementById('titlebar-minimize');
        const maximizeBtn = document.getElementById('titlebar-maximize');
        const closeBtn = document.getElementById('titlebar-close');

        // Mettre √† jour le logo de la titlebar selon le th√®me
        function updateTitlebarLogo(theme) {
          if (titlebarLogo) {
            titlebarLogo.src = theme === 'dark'
              ? '../../assets/icons/ico/TONTONKADB.png'
              : '../../assets/icons/ico/TONTONKADN.png';
          }
        }

        // Appliquer le th√®me initial
        const savedTheme = localStorage.getItem('tontonkad-theme') || 'light';
        updateTitlebarLogo(savedTheme);

        // Toggle th√®me depuis la titlebar
        if (titlebarThemeToggle) {
          titlebarThemeToggle.addEventListener('click', () => {
            // D√©clencher le toggle du th√®me principal
            const mainThemeSwitcher = document.getElementById('theme-switcher');
            if (mainThemeSwitcher) {
              mainThemeSwitcher.click();
            }
          });
        }

        // Observer les changements de th√®me pour mettre √† jour le logo
        const observer = new MutationObserver((mutations) => {
          mutations.forEach((mutation) => {
            if (mutation.attributeName === 'data-theme') {
              const newTheme = document.documentElement.getAttribute('data-theme');
              updateTitlebarLogo(newTheme);
            }
          });
        });
        observer.observe(document.documentElement, { attributes: true });

        // Boutons de contr√¥le
        if (minimizeBtn) {
          minimizeBtn.addEventListener('click', () => {
            window.electronAPI.windowMinimize();
          });
        }

        if (maximizeBtn) {
          maximizeBtn.addEventListener('click', () => {
            window.electronAPI.windowMaximize();
          });
        }

        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            window.electronAPI.windowClose();
          });
        }
      }
    });
  </script>

  <!-- Electron integration -->
  <script src="electron-integration.js"></script>

</body></html>
